name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    strategy:
      fail-fast: false
      matrix:
        os: [macos-26, macos-15, ubuntu-24.04]
        node: [24, 25]
    runs-on: ${{ matrix.os }}
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}

      - name: Install pi
        run: npm install -g @mariozechner/pi-coding-agent

      - name: Install package from git
        run: |
          mkdir -p /tmp/test-project && cd /tmp/test-project
          pi install -l "https://github.com/${{ github.repository }}@${{ github.sha }}"

      - name: Verify extension discovery
        run: |
          cd /tmp/test-project
          # Spawn pi in RPC mode, send get_commands
          # Use a dummy API key so pi doesn't exit early looking for a provider
          output=$(echo '{"type":"get_commands"}' | timeout 30 ANTHROPIC_API_KEY=sk-test pi --mode rpc --no-session 2>/tmp/pi-stderr || true)

          echo "--- stderr ---"
          cat /tmp/pi-stderr || true
          echo "--- stdout ---"
          echo "$output" | head -5

          # Check that all three deep-dive commands are registered
          for cmd in deep-dive deep-dive-resume deep-dive-stop; do
            if echo "$output" | grep -q "\"name\":\"$cmd\""; then
              echo "✓ /$cmd registered"
            else
              echo "✗ /$cmd NOT found"
              exit 1
            fi
          done

      - name: Lint — no hardcoded user paths
        run: |
          if grep -rn '/Users/rez\|/home/rez' pi-extensions/; then
            echo "✗ Found hardcoded user paths in source"
            exit 1
          fi
          echo "✓ No hardcoded user paths"

      - name: Lint — pinned versions only
        run: |
          if grep -n '@latest' pi-extensions/deep-dive/index.ts; then
            echo "✗ Found @latest reference"
            exit 1
          fi
          echo "✓ All versions pinned"

      - name: Validate CDN URLs
        run: |
          urls=(
            "https://cdn.jsdelivr.net/npm/mermaid@11.4.0/dist/mermaid.min.js"
            "https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"
            "https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css"
            "https://cdn.tailwindcss.com/3.4.17"
          )
          for url in "${urls[@]}"; do
            status=$(curl -sI -o /dev/null -w "%{http_code}" --max-time 10 "$url")
            if [ "$status" = "200" ]; then
              echo "✓ $url"
            else
              echo "✗ $url (HTTP $status)"
              exit 1
            fi
          done
