name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    strategy:
      fail-fast: false
      matrix:
        os: [macos-26, macos-15, ubuntu-24.04]
        node: [22]
    runs-on: ${{ matrix.os }}
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}

      - name: Install pi
        run: npm install -g @mariozechner/pi-coding-agent

      - name: Install package locally
        run: |
          mkdir -p /tmp/test-project && cd /tmp/test-project
          pi install -l "$GITHUB_WORKSPACE"

      - name: Verify extension discovery
        run: |
          cd /tmp/test-project
          # Spawn pi in RPC mode, ask for registered commands, exit
          output=$(echo '{"type":"get_commands"}' | timeout 30 pi --mode rpc --no-session 2>/dev/null || true)

          # Check that all three deep-dive commands are registered
          for cmd in deep-dive deep-dive-resume deep-dive-stop; do
            if echo "$output" | grep -q "\"name\":\"$cmd\""; then
              echo "✓ /$cmd registered"
            else
              echo "✗ /$cmd NOT found"
              echo "Output was:"
              echo "$output" | head -20
              exit 1
            fi
          done

      - name: Verify extension source path
        run: |
          cd /tmp/test-project
          output=$(echo '{"type":"get_commands"}' | timeout 30 pi --mode rpc --no-session 2>/dev/null || true)

          # Verify commands come from our extension file
          if echo "$output" | grep -q '"path":".*boring/pi-extensions/deep-dive/index.ts"'; then
            echo "✓ Commands loaded from correct extension path"
          else
            echo "✗ Extension path mismatch"
            exit 1
          fi

      - name: Lint — no hardcoded user paths
        run: |
          if grep -rn '/Users/rez\|/home/rez' pi-extensions/; then
            echo "✗ Found hardcoded user paths in source"
            exit 1
          fi
          echo "✓ No hardcoded user paths"

      - name: Lint — pinned versions only
        run: |
          if grep -n '@latest' pi-extensions/deep-dive/index.ts; then
            echo "✗ Found @latest reference"
            exit 1
          fi
          echo "✓ All versions pinned"

      - name: Validate CDN URLs
        run: |
          urls=(
            "https://cdn.jsdelivr.net/npm/mermaid@11.4.0/dist/mermaid.min.js"
            "https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"
            "https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css"
            "https://cdn.tailwindcss.com/3.4.17"
          )
          for url in "${urls[@]}"; do
            status=$(curl -sI -o /dev/null -w "%{http_code}" --max-time 10 "$url")
            if [ "$status" = "200" ]; then
              echo "✓ $url"
            else
              echo "✗ $url (HTTP $status)"
              exit 1
            fi
          done
